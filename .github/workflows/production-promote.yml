name: Promote Staging to Production

on:
  workflow_dispatch:
    inputs:
      staging_tag:
        description: 'Staging image tag to promote (e.g., staging-abc1234 or latest)'
        required: true
        default: 'latest'
      confirm_promotion:
        description: 'Type "PROMOTE" to confirm production deployment'
        required: true
      skip_smoke_tests:
        description: 'Skip smoke tests before promotion (not recommended)'
        required: false
        default: 'false'
        type: boolean

# Minimal permissions required for this workflow
permissions:
  contents: read

env:
  STAGING_TAG: ${{ github.event.inputs.staging_tag }}
  PRODUCTION_TAG: production-${{ github.sha }}

jobs:
  validate-inputs:
    runs-on: ubuntu-latest
    permissions: {}
    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_promotion }}" != "PROMOTE" ]; then
            echo "‚ùå Error: You must type 'PROMOTE' to confirm production deployment"
            echo "Received: '${{ github.event.inputs.confirm_promotion }}'"
            exit 1
          fi
          echo "‚úÖ Promotion confirmed"

  pre-promotion-tests:
    runs-on: ubuntu-latest
    needs: validate-inputs
    if: ${{ github.event.inputs.skip_smoke_tests != 'true' }}
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        if: ${{ secrets.DOCKERHUB_USERNAME != '' }}
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        continue-on-error: true

      - name: Pull staging images
        run: |
          DOCKERHUB_USERNAME="${{ secrets.DOCKERHUB_USERNAME }}"
          if [ -z "$DOCKERHUB_USERNAME" ]; then
            echo "No DOCKERHUB_USERNAME set, building images locally"
            docker build -t local/pos-backend:${{ env.STAGING_TAG }} ./backend
            docker build -t local/pos-frontend:${{ env.STAGING_TAG }} ./frontend
          else
            docker pull $DOCKERHUB_USERNAME/pos-backend:${{ env.STAGING_TAG }} || \
              docker build -t $DOCKERHUB_USERNAME/pos-backend:${{ env.STAGING_TAG }} ./backend
            docker pull $DOCKERHUB_USERNAME/pos-frontend:${{ env.STAGING_TAG }} || \
              docker build -t $DOCKERHUB_USERNAME/pos-frontend:${{ env.STAGING_TAG }} ./frontend
          fi

      - name: Start staging containers for testing
        run: |
          export DOCKERHUB_USERNAME="${{ secrets.DOCKERHUB_USERNAME }}"
          if [ -z "$DOCKERHUB_USERNAME" ]; then
            export DOCKERHUB_USERNAME="local"
          fi
          export IMAGE_TAG=${{ env.STAGING_TAG }}
          docker compose -f docker-compose.staging.yml up -d --wait --wait-timeout 120

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for backend health check..."
          for i in {1..30}; do
            if curl -sf http://localhost:8000/health; then
              echo "Backend is healthy!"
              break
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 5
          done

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Playwright
        working-directory: ./e2e
        run: |
          npm ci
          npx playwright install --with-deps chromium

      - name: Run smoke tests
        working-directory: ./e2e
        run: npx playwright test --project=chromium
        env:
          BASE_URL: http://localhost:3000
          API_URL: http://localhost:8000

      - name: Cleanup test containers
        if: always()
        run: |
          docker compose -f docker-compose.staging.yml down -v || true

  approve-promotion:
    runs-on: ubuntu-latest
    needs: [validate-inputs, pre-promotion-tests]
    if: ${{ always() && needs.validate-inputs.result == 'success' && (needs.pre-promotion-tests.result == 'success' || needs.pre-promotion-tests.result == 'skipped') }}
    environment: production
    permissions: {}
    steps:
      - name: Request manual approval
        run: |
          echo "üöÄ Promotion Approved!"
          echo "Staging tag: ${{ env.STAGING_TAG }}"
          echo "This deployment requires manual approval in GitHub."
          echo "Please review the staging test results before approving."

  promote-to-production:
    runs-on: ubuntu-latest
    needs: approve-promotion
    permissions:
      contents: read
    steps:
      - name: Validate Docker Hub credentials
        run: |
          if [ -z "${{ secrets.DOCKERHUB_USERNAME }}" ] || [ -z "${{ secrets.DOCKERHUB_TOKEN }}" ]; then
            echo "‚ùå Error: DOCKERHUB_USERNAME and DOCKERHUB_TOKEN secrets must be configured"
            echo "Please add these secrets in your repository settings to enable production promotion."
            exit 1
          fi
          echo "‚úÖ Docker Hub credentials are configured"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull staging images
        run: |
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/pos-backend:${{ env.STAGING_TAG }}
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/pos-frontend:${{ env.STAGING_TAG }}

      - name: Tag and push as production
        run: |
          # Tag with specific version
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/pos-backend:${{ env.STAGING_TAG }} \
            ${{ secrets.DOCKERHUB_USERNAME }}/pos-backend:${{ env.PRODUCTION_TAG }}
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/pos-frontend:${{ env.STAGING_TAG }} \
            ${{ secrets.DOCKERHUB_USERNAME }}/pos-frontend:${{ env.PRODUCTION_TAG }}
          
          # Tag as latest production
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/pos-backend:${{ env.STAGING_TAG }} \
            ${{ secrets.DOCKERHUB_USERNAME }}/pos-backend:production
          docker tag ${{ secrets.DOCKERHUB_USERNAME }}/pos-frontend:${{ env.STAGING_TAG }} \
            ${{ secrets.DOCKERHUB_USERNAME }}/pos-frontend:production
          
          # Push all tags
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/pos-backend:${{ env.PRODUCTION_TAG }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/pos-frontend:${{ env.PRODUCTION_TAG }}
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/pos-backend:production
          docker push ${{ secrets.DOCKERHUB_USERNAME }}/pos-frontend:production

      - name: Create deployment record
        run: |
          echo "üìã Deployment Record"
          echo "===================="
          echo "Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "Staging Tag: ${{ env.STAGING_TAG }}"
          echo "Production Tag: ${{ env.PRODUCTION_TAG }}"
          echo "Commit SHA: ${{ github.sha }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "===================="

  notify-completion:
    runs-on: ubuntu-latest
    needs: promote-to-production
    if: always()
    permissions: {}
    steps:
      - name: Deployment success notification
        if: needs.promote-to-production.result == 'success'
        run: |
          echo "‚úÖ Production deployment completed successfully!"
          echo "Images promoted:"
          echo "  - pos-backend:production"
          echo "  - pos-frontend:production"

      - name: Deployment failure notification
        if: needs.promote-to-production.result == 'failure'
        run: |
          echo "‚ùå Production deployment failed!"
          echo "Please check the workflow logs for details."
          exit 1
