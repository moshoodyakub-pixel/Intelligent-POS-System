name: Deploy to Staging & Run Smoke Tests

on:
  push:
    branches:
      - staging
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Commit SHA to deploy (defaults to latest)'
        required: false
        default: ''

env:
  IMAGE_TAG: ${{ github.event.inputs.commit_sha || github.sha }}

jobs:
  deploy-and-test:
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.commit_sha || github.sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        if: ${{ env.DOCKERHUB_USERNAME != '' && env.DOCKERHUB_TOKEN != '' }}
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        continue-on-error: true

      - name: Try to pull images from Docker Hub
        id: pull-images
        run: |
          if [ -n "$DOCKERHUB_USERNAME" ]; then
            docker pull "$DOCKERHUB_USERNAME/pos-backend:latest" && echo "backend_pulled=true" >> $GITHUB_OUTPUT || echo "backend_pulled=false" >> $GITHUB_OUTPUT
            docker pull "$DOCKERHUB_USERNAME/pos-frontend:latest" && echo "frontend_pulled=true" >> $GITHUB_OUTPUT || echo "frontend_pulled=false" >> $GITHUB_OUTPUT
          else
            echo "backend_pulled=false" >> $GITHUB_OUTPUT
            echo "frontend_pulled=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true

      - name: Build backend image locally if not pulled
        if: steps.pull-images.outputs.backend_pulled != 'true'
        run: |
          docker build -t "${DOCKERHUB_USERNAME:-local}/pos-backend:latest" ./backend

      - name: Build frontend image locally if not pulled
        if: steps.pull-images.outputs.frontend_pulled != 'true'
        run: |
          docker build -t "${DOCKERHUB_USERNAME:-local}/pos-frontend:latest" ./frontend

      - name: Deploy to staging
        id: deploy
        run: |
          # Default to 'local' if DOCKERHUB_USERNAME is not set
          if [ -z "$DOCKERHUB_USERNAME" ]; then
            export DOCKERHUB_USERNAME="local"
          fi
          export IMAGE_TAG=latest
          docker compose -f docker-compose.staging.yml up -d --wait --wait-timeout 120
          echo "backend_url=http://localhost:8000" >> $GITHUB_OUTPUT
          echo "frontend_url=http://localhost:3000" >> $GITHUB_OUTPUT

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for backend health check..."
          for i in {1..30}; do
            if curl -sf http://localhost:8000/health; then
              echo "Backend is healthy!"
              break
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 5
          done
          
          echo "Waiting for frontend..."
          for i in {1..30}; do
            if curl -sf http://localhost:3000; then
              echo "Frontend is healthy!"
              break
            fi
            echo "Waiting for frontend... ($i/30)"
            sleep 5
          done

      - name: Run health endpoint checks
        run: |
          echo "Checking backend health endpoint..."
          curl -sf http://localhost:8000/health | jq .
          
          echo "Checking backend root endpoint..."
          curl -sf http://localhost:8000/ | jq .
          
          echo "Checking frontend..."
          curl -sf http://localhost:3000 -o /dev/null && echo "Frontend OK"

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Playwright
        working-directory: ./e2e
        run: |
          npm ci
          npx playwright install --with-deps chromium

      - name: Run E2E smoke tests
        working-directory: ./e2e
        run: npx playwright test --project=chromium
        env:
          BASE_URL: http://localhost:3000
          API_URL: http://localhost:8000

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: e2e/playwright-report/
          retention-days: 7

      - name: Upload test screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-screenshots
          path: e2e/test-results/
          retention-days: 7

      - name: Cleanup staging environment
        if: always()
        run: |
          docker compose -f docker-compose.staging.yml down -v || true
