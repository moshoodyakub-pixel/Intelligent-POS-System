name: Deploy to Staging & Run Smoke Tests

on:
  push:
    branches:
      - staging
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      commit_sha:
        description: 'Commit SHA to deploy (defaults to latest)'
        required: false
        default: ''

env:
  IMAGE_TAG: ${{ github.event.inputs.commit_sha || github.sha }}

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    outputs:
      backend_url: ${{ steps.deploy.outputs.backend_url }}
      frontend_url: ${{ steps.deploy.outputs.frontend_url }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.commit_sha || github.sha }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Pull images from CI
        run: |
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/pos-backend:latest || echo "Using local build"
          docker pull ${{ secrets.DOCKERHUB_USERNAME }}/pos-frontend:latest || echo "Using local build"

      - name: Deploy to staging
        id: deploy
        run: |
          export DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
          export IMAGE_TAG=latest
          docker compose -f docker-compose.staging.yml up -d --wait --wait-timeout 120
          echo "backend_url=http://localhost:8000" >> $GITHUB_OUTPUT
          echo "frontend_url=http://localhost:3000" >> $GITHUB_OUTPUT

      - name: Wait for services to be healthy
        run: |
          echo "Waiting for backend health check..."
          for i in {1..30}; do
            if curl -sf http://localhost:8000/health; then
              echo "Backend is healthy!"
              break
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 5
          done
          
          echo "Waiting for frontend..."
          for i in {1..30}; do
            if curl -sf http://localhost:3000; then
              echo "Frontend is healthy!"
              break
            fi
            echo "Waiting for frontend... ($i/30)"
            sleep 5
          done

      - name: Run health endpoint checks
        run: |
          echo "Checking backend health endpoint..."
          curl -sf http://localhost:8000/health | jq .
          
          echo "Checking backend root endpoint..."
          curl -sf http://localhost:8000/ | jq .
          
          echo "Checking frontend..."
          curl -sf http://localhost:3000 -o /dev/null && echo "Frontend OK"

  smoke-tests:
    runs-on: ubuntu-latest
    needs: deploy-staging
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install Playwright
        run: |
          cd e2e
          npm ci
          npx playwright install --with-deps chromium

      - name: Run E2E smoke tests
        run: |
          cd e2e
          npx playwright test --project=chromium
        env:
          BASE_URL: ${{ needs.deploy-staging.outputs.frontend_url }}
          API_URL: ${{ needs.deploy-staging.outputs.backend_url }}

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: e2e/playwright-report/
          retention-days: 7

      - name: Upload test screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: test-screenshots
          path: e2e/test-results/
          retention-days: 7

  cleanup:
    runs-on: ubuntu-latest
    needs: [deploy-staging, smoke-tests]
    if: always()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cleanup staging environment
        run: |
          docker compose -f docker-compose.staging.yml down -v || true
